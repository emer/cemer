########### maketa target ###############

# Bug 1424
# CMake's dependency scanner is really stupid -- it doesn't actually
# preprocess header files to determine dependencies, it just scans
# for #include lines.  Consequently, it thinks maketa depends on
# files like svnrev.h and ta_TA_type.h, when in fact it does not --
# there's no way it could depend on ta_TA_type.h, since that file is
# generated by maketa!
#
# The 'fakeheaders' subdirectory contains dummy versions of those
# header files.  The compiler will never see them, but CMake will.
# This should help build avoidance.
#
# Only maketa code knows about this include directory; the BEFORE
# argument tells CMake to put this include directory first.
include_directories(
  BEFORE
  ${PROJECT_SOURCE_DIR}/src/temt/maketa/fakeheaders
)

set(maketa_HEADS
  ../ta/ta_stdef.h
  ../ta/ta_platform.h
  ../ta/ta_string.h
  ../ta/ta_variant.h
  ../ta/ta_mtrnd.h
  ../ta/ta_list.h
  ../ta/ta_type.h
  mta_parse.h
  mta_constr.h
  maketa.h
)

set(maketa_SRCS
  ../ta/ta_ti.cpp
  ../ta/ta_platform.cpp
  ../ta/ta_string.cpp
  ../ta/ta_variant.cpp
  ../ta/ta_mtrnd.cpp
  ../ta/ta_list.cpp
  ../ta/ta_type.cpp
  mta_parse.cpp
  mta_lex.cpp
  mta_constr.cpp
  mta_gendoc.cpp
  maketa.cpp
)

set(maketa_FILES ${maketa_HEADS} ${maketa_SRCS})

 add_definitions(-DNO_TA_BASE)
# note: special definitions for compiling maketa: always optimized
if (WIN32)
# :( /O2 is incompatible with /RTC1 that gets set automatically
#  add_definitions(/O2)
else (WIN32)
  add_definitions(-O2 -g)
endif (WIN32)

#NOTE: we don't use decorative suffix -- confusing, and there should only be one
add_executable(maketa ${maketa_SRCS})


########### running bison on mta_parse.y ###############

# note: change TARGET -> COMMAND and uncomment OUTPUT to get auto-building
ADD_CUSTOM_TARGET(make_mta_parse
#  OUTPUT mta_parse.cpp mta_parse.h
  WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
  COMMAND bison -dtvy mta_parse.y
  COMMAND sed -e "s/union/struct/g" y.tab.c >mta_parse.cpp
  COMMAND sed -e "s/union/struct/g" y.tab.h >mta_parse.hxx
  COMMAND cmp -s mta_parse.hxx mta_parse.h || cp mta_parse.hxx mta_parse.h
  DEPENDS mta_parse.y
  )

########### install files ###############

install(TARGETS maketa
  RUNTIME DESTINATION bin
  OPTIONAL #TEMP
)

